承知いたしました。
それでは、「ドクターカー・オールインワンアプリ」のデモ版開発に向けた、**実装レベルの詳細開発仕様書**を作成します。

この仕様書は、エンジニアがこれを読むだけで実装に着手できるよう、画面、機能、データ構造を具体的に定義することを目的とします。

---

## 【開発仕様書】ドクターカー・オールインワンアプリ (PoC版)

### 1. プロジェクト概要

#### 1.1. プロジェクト名
Doctor Car All-in-One Application (D-Call App) - Proof of Concept

#### 1.2. 目的
リアルタイム情報共有によるドクターカー業務の効率化と医療の質向上というコンセプトの価値を、関係者が直感的に体験できるデモアプリを開発する。

#### 1.3. ターゲットユーザー
*   **ドクターカー隊員** (医師/看護師)
*   **病院スタッフ** (受け入れ担当)

#### 1.4. 開発スコープ
要件定義で定めた以下のコア機能に絞る。
*   出動事案管理
*   リアルタイム患者情報入力・共有
*   GPSマップ連携
*   簡易チャット機能

#### 1.5. 技術スタック
| カテゴリ | 技術選定 | 理由 |
| :--- | :--- | :--- |
| **フロントエンド** | React (with Vite), TypeScript | 高速な開発体験と型安全性を提供し、豊富なライブラリエコシステムを持つため。 |
| **バックエンド** | Firebase (BaaS) | 認証、リアルタイムDB、ストレージ等の機能を備え、サーバー構築不要で迅速に開発できるため。 |
| **DB** | Cloud Firestore | リアルタイム同期に優れ、柔軟なデータ構造を持つため。 |
| **スタイリング** | Tailwind CSS | ユーティリティファーストで迅速なUI構築が可能なため。 |
| **地図** | Leaflet | オープンソースで無料、軽量で地図表示を容易に実装できるため。 |
| **状態管理** | Zustand / React Context | シンプルで学習コストが低く、今回のスコープに適しているため。 |

---

### 2. データベース（Cloud Firestore）詳細スキーマ

#### 2.1. コレクション構造
```
/users/{userId}
/cases/{caseId}
  ├─ /vitals/{vitalId}
  ├─ /treatments/{treatmentId}
  ├─ /messages/{messageId}
  └─ /locations/{locationId}
```

#### 2.2. `users` コレクション
ユーザー情報を格納。

| フィールド名 | データ型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `uid` | string | Firebase AuthenticationのUID | `abcdefg12345` |
| `name` | string | ユーザー名 | `山田 太郎` |
| `role` | string | 役割 (`doctor_car` or `hospital`) | `doctor_car` |
| `team` | string | 所属チーム/病院名 | `東京科学大学病院` |

#### 2.3. `cases` コレクション
出動事案のマスター情報。

| フィールド名 | データ型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `caseName` | string | 事案名（例：日付＋概要） | `2024-10-26 渋谷駅前 交通外傷` |
| `status` | string | 事案のステータス (`dispatched`, `on_scene`, `transporting`, `completed`) | `on_scene` |
| `teamId` | string | 担当チームID（`users`の`uid`等） | `team_A` |
| `patientInfo` | map | 患者の基本情報 | `{ "age": 45, "gender": "male" }` |
| `sceneLocation` | GeoPoint | 現場の緯度経度 | `[35.658, 139.701]` |
| `hospitalLocation`| GeoPoint | 搬送先病院の緯度経度 | `[35.660, 139.703]` |
| `createdAt` | Timestamp | 事案作成日時 | `October 26, 2024 at 10:00:00 AM UTC+9` |

#### 2.4. サブコレクション詳細

*   **`vitals`** (cases/{caseId}/vitals)
    | フィールド名 | データ型 | 説明 | 例 |
    | :--- | :--- | :--- | :--- |
    | `timestamp` | Timestamp | 記録日時 | `...` |
    | `hr` | number | 心拍数 | `90` |
    | `bp_s` | number | 収縮期血圧 | `120` |
    | `bp_d` | number | 拡張期血圧 | `80` |
    | `spo2` | number | 酸素飽和度 | `98` |
    | `recordedBy` | string | 記録者名 | `山田 太郎` |

*   **`messages`** (cases/{caseId}/messages)
    | フィールド名 | データ型 | 説明 | 例 |
    | :--- | :--- | :--- | :--- |
    | `timestamp` | Timestamp | 送信日時 | `...` |
    | `senderId` | string | 送信者UID | `abcdefg12345` |
    | `senderName`| string | 送信者名 | `山田 太郎` |
    | `text` | string | メッセージ本文 | `頭部外傷あり。CT準備お願いします。` |

---

### 3. 画面仕様と機能詳細

#### 3.1. 画面フロー
`ログイン` -> `事案一覧` -> `事案詳細 (メイン画面)`

#### 3.2. SCR-001: ログイン画面
*   **URLパス:** `/login`
*   **ワイヤーフレーム:**
    ```
    +--------------------------------------+
    |          D-Call App (Logo)           |
    |                                      |
    |  メールアドレス: [____________]      |
    |  パスワード:   [____________]        |
    |                                      |
    |            [ ログイン ]              |
    |                                      |
    |  [デモ用: ドクターカー隊員でログイン] |
    |  [デモ用: 病院スタッフでログイン]   |
    +--------------------------------------+
    ```
*   **機能仕様:**
    1.  **メール/パスワード入力:** `useState`で管理。
    2.  **ログインボタン:**
        *   `onClick`: Firebase Authの`signInWithEmailAndPassword`を呼び出す。
        *   成功時: `/cases` (事案一覧画面)にリダイレクト。
        *   失敗時: エラーメッセージを表示。
    3.  **デモ用ログインボタン:**
        *   `onClick`: 事前に用意したデモアカウント情報で`signInWithEmailAndPassword`を呼び出し、ログイン処理を簡略化する。

#### 3.3. SCR-002: 事案一覧画面
*   **URLパス:** `/cases`
*   **ワイヤーフレーム:**
    ```
    +--------------------------------------+
    | D-Call App  [ユーザー名] [ログアウト] |
    +--------------------------------------+
    |                事案一覧                |
    | +----------------------------------+ |
    | | 2024-10-26 渋谷駅前   [進行中] > | |
    | +----------------------------------+ |
    | | 2024-10-25 新宿区内   [完了]   > | |
    | +----------------------------------+ |
    |                  ...                 |
    +--------------------------------------+
    ```
*   **機能仕様:**
    1.  **データ取得:**
        *   画面表示時(`useEffect`)に、Cloud Firestoreの`cases`コレクションからデータを取得するクエリを発行。
        *   `onSnapshot`を利用してリアルタイム更新に対応する。
    2.  **一覧表示:**
        *   取得した事案データを`map`メソッドでリスト表示する。
        *   各アイテムは`Card`コンポーネントとして実装。`status`に応じてバッジの色を変える。
    3.  **事案選択:**
        *   各事案アイテムをクリックすると、`/cases/{caseId}`パスに遷移する。
    4.  **ログアウト:**
        *   Firebase Authの`signOut`を呼び出し、`/login`にリダイレクト。

#### 3.4. SCR-003: 事案詳細画面 (メイン)
*   **URLパス:** `/cases/:caseId`
*   **ワイヤーフレーム (3ペインレイアウト):**
    ```
    +--------------------------------------------------------------------+
    | [<- 一覧へ]  2024-10-26 渋谷駅前 [ステータス: 現場活動中]            |
    +----------------------------------+---------------------------------+
    |                                  |                                 |
    |      【マップ表示エリア】        |      【患者情報タイムライン】   |
    |                                  |  10:05 [バイタル] HR:90 BP:120/80|
    |  (ドクターカーアイコン)          |  10:06 [処置] ルート確保        |
    |  (現場アイコン)                  |  10:08 [バイタル] HR:95 BP:110/70|
    |                                  |  ...                             |
    |                                  |  + [バイタル入力] + [処置入力]  |
    +----------------------------------+---------------------------------+
    |                                                                    |
    |                          【チャットエリア】                        |
    |  [病院] 受け入れ可。脳外科医待機中。                               |
    |                                        [現場] 了解しました。       |
    |  [_______________________________________] [送信]                    |
    +--------------------------------------------------------------------+
    ```
*   **機能仕様:**

    *   **全体:**
        *   URLパラメータから`caseId`を取得。
        *   `caseId`を元に、`cases`ドキュメントと各サブコレクション(`vitals`, `messages`等)を`onSnapshot`でリアルタイム購読する。
        *   取得したデータは`Zustand`等の状態管理ストアで一元管理し、各コンポーネントに配布する。

    *   **マップ表示エリア (`MapComponent`):**
        1.  `Leaflet`ライブラリ等で地図を表示。
        2.  `cases`ドキュメントから現場・病院の位置情報を取得し、マーカーを配置。
        3.  `locations`サブコレクションを購読し、最新の位置情報に基づいてドクターカーのアイコンをリアルタイムで移動させる。

    *   **患者情報タイムライン (`TimelineComponent`):**
        1.  `vitals`と`treatments`サブコレクションのデータを購読する。
        2.  両コレクションのデータをマージし、`timestamp`でソートして時系列に表示する。
        3.  **バイタル入力ボタン:** (ドクターカー隊員のみ表示)
            *   `onClick`: バイタル（HR, BP, SpO2）を入力するモーダルダイアログを開く。
            *   保存時: 入力値を`vitals`サブコレクションに`addDoc`で新規追加する。`timestamp`と`recordedBy`も付与。
        4.  **処置入力ボタン:** (ドクターカー隊員のみ表示)
            *   `onClick`: 処置内容をテキスト入力するモーダルを開く。
            *   保存時: `treatments`サブコレクションにデータを追加。

    *   **チャットエリア (`ChatComponent`):**
        1.  `messages`サブコレクションを購読し、メッセージ一覧を時系列で表示する。
        2.  送信者IDが自分か他人かで、吹き出しの左右を分ける。
        3.  **メッセージ入力・送信:**
            *   入力したテキストと`senderId`, `senderName`, `timestamp`をオブジェクトとして`messages`サブコレクションに`addDoc`で追加する。
            *   送信後、入力欄はクリアする。

---

### 4. 開発タスクリスト (WBS)

| No. | タスク名 | 担当者 | 見積(人日) | 依存タスク | 備考 |
| :-- | :--- | :--- | :--- | :--- |:--- |
| 1 | **環境構築** | - | 0.5 | - | Vite+React+TSプロジェクト作成、Firebase設定 |
| 2 | **Firebaseセットアップ** | - | 0.5 | - | Firestore DB作成、Authentication有効化 |
| 3 | **DBスキーマ定義と初期データ投入** | - | 0.5 | 2 | デモ用の`users`, `cases`データを手動で投入 |
| 4 | **共通コンポーネント開発** | - | 1.0 | 1 | Button, Card, Input, Modal等 |
| 5 | **SCR-001: ログイン画面実装** | - | 1.0 | 1, 2, 4 | Firebase Authとの連携 |
| 6 | **SCR-002: 事案一覧画面実装** | - | 1.0 | 3, 5 | Firestoreからのデータ取得と表示 |
| 7 | **SCR-003: 事案詳細画面 (レイアウト)** | - | 0.5 | 6 | 3ペインの基本レイアウト構築 |
| 8 | **SCR-003: マップコンポーネント実装** | - | 1.5 | 7 | Leaflet連携、リアルタイム位置更新 |
| 9 | **SCR-003: タイムラインコンポーネント実装**| - | 2.0 | 7 | データ表示、入力モーダル、Firestoreへの書き込み |
| 10 |**SCR-003: チャットコンポーネント実装** | - | 1.5 | 7 | リアルタイムメッセージング機能 |
| 11 |**状態管理の導入と統合** | - | 1.0 | 5-10 | Zustand/Contextでアプリ全体の状態を整理 |
| 12 |**総合テスト・デバッグ** | - | 1.0 | 11 | 全体の動作確認と微調整 |
| | **合計** | | **12.0** | | |

この仕様書に基づき、各タスクを順に進めることで、計画的かつ効率的にデモアプリの開発が可能です。